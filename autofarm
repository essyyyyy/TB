repeat wait() until game:IsLoaded()
wait(3)
warn("Script is running")

local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local VirtualUser = game:GetService("VirtualUser")

_G.count = 0
_G.test2 = true

-- Enable ScreenGui
if LocalPlayer.PlayerGui:FindFirstChild("ScreenGui") then
    LocalPlayer.PlayerGui.ScreenGui.Enabled = true
end

LocalPlayer.Idled:Connect(function()
    VirtualUser:Button2Down(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
    wait(1)
    VirtualUser:Button2Up(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
end)

local function safeRejoin()
    warn("Rejoining...")
    _G.count = 0
    TeleportService:Teleport(game.PlaceId)
end

spawn(function()
    while task.wait(1) do
        local activeQuest = LocalPlayer.ActiveQuests:FindFirstChild("contractBuildMaterial")
        if not activeQuest and _G.count < 10 then
            _G.count = _G.count + 1
        elseif not activeQuest and _G.count >= 10 then
            safeRejoin()
        else
            _G.count = 0
        end
    end
end)

spawn(function()
    while _G.test2 do
        local activeQuest = LocalPlayer.ActiveQuests:FindFirstChild("contractBuildMaterial")
        if not activeQuest then
            -- Start the contract
            pcall(function()
                ReplicatedStorage.Quests.Contracts.StartContract:InvokeServer("contractBuildMaterial")
            end)
            
            repeat task.wait() until LocalPlayer.ActiveQuests:FindFirstChild("contractBuildMaterial")
        end
        
        repeat
            pcall(function()
                ReplicatedStorage.Quests.DeliveryComplete:InvokeServer("contractMaterial")
            end)
            task.wait()
        until LocalPlayer.ActiveQuests.contractBuildMaterial.Value == "!pw5pi3ps2"
        
        pcall(function()
            ReplicatedStorage.Quests.Contracts.CompleteContract:InvokeServer()
        end)
        task.wait()
    end
end)
